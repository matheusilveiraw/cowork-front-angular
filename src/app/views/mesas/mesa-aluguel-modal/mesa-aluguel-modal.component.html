<div class="modal-backdrop fade show" *ngIf="abrir"></div>

<div class="modal fade show d-block" *ngIf="abrir" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <!-- Header do Modal -->
      <div class="modal-header">
        <h5 class="modal-title">
          {{ mesaSelecionada ? 'Alugar Mesa ' + mesaSelecionada.numberDesks : 'Alugar Mesa' }}
        </h5>
        <button type="button" class="btn-close" (click)="onFechar()" aria-label="Close"></button>
      </div>

      <!-- Formulário de Aluguel -->
      <form (ngSubmit)="onSalvar()" #aluguelForm="ngForm">
        <div class="modal-body">

          <!-- Seleção de Mesa (se for aluguel geral) -->
          <div class="mb-3" *ngIf="!mesaSelecionada">
            <label for="mesaSelect" class="form-label">Selecionar Mesa *</label>
            <select class="form-select" id="mesaSelect" name="idDesks" [(ngModel)]="aluguelFormData.idDesks" required
              #mesaSelect="ngModel">
              <option value="">Selecione uma mesa</option>
              <option *ngFor="let mesa of mesasDisponiveis" [value]="mesa.idDesks">
                Mesa {{ mesa.numberDesks }} - {{ mesa.nameDesks || 'Sem nome' }}
              </option>
            </select>
            <div *ngIf="mesaSelect.invalid && mesaSelect.touched" class="text-danger">
              <small>Seleção da mesa é obrigatória</small>
            </div>
          </div>

          <!-- Informações da Mesa Selecionada -->
          <div class="mb-3" *ngIf="mesaSelecionada">
            <label class="form-label">Mesa Selecionada</label>
            <div class="alert alert-info">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <strong>Mesa {{ mesaSelecionada.numberDesks }}</strong> -
                  {{ mesaSelecionada.nameDesks || 'Sem nome' }}
                </div>
                <button type="button" class="btn btn-outline-secondary btn-sm" (click)="onAbrirModalAluguelGeral()"
                  title="Alterar mesa">
                  Alterar Mesa
                </button>
              </div>
            </div>
          </div>

          <!-- Seleção de Cliente -->
          <div class="mb-3">
            <label for="clienteSelect" class="form-label">Cliente *</label>
            <select class="form-select" id="clienteSelect" name="idCustomers" [(ngModel)]="aluguelFormData.idCustomers"
              required #clienteSelect="ngModel">
              <option value="">Selecione um cliente</option>
              <option *ngFor="let cliente of clientes" [value]="cliente.idCustomers">
                {{ cliente.nameCustomers }} - {{ cliente.emailCustomers }}
              </option>
            </select>
            <div *ngIf="clienteSelect.invalid && clienteSelect.touched" class="text-danger">
              <small>Seleção do cliente é obrigatória</small>
            </div>
            <div class="form-text">
              <a href="javascript:void(0)" (click)="onAbrirModalCliente()" class="text-primary">
                + Cadastrar novo cliente
              </a>
            </div>
          </div>

          <!-- Seleção de Plano -->
          <div class="mb-3">
            <label for="planoSelect" class="form-label">Plano de Aluguel *</label>
            <select class="form-select" id="planoSelect" name="idRentalPlans"
              [(ngModel)]="aluguelFormData.idRentalPlans" required (change)="onPlanoChange()" #planoSelect="ngModel">
              <option value="">Selecione um plano</option>
              <option *ngFor="let plano of planosAluguel" [value]="plano.idRentalPlans">
                {{ plano.planNameRentalPlans }} - R$ {{ plano.priceRentalPlans }}
              </option>
            </select>
            <div *ngIf="planoSelect.invalid && planoSelect.touched" class="text-danger">
              <small>Seleção do plano é obrigatória</small>
            </div>
          </div>

          <!-- Período do Aluguel -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="dataInicio" class="form-label">Data de Início *</label>
              <input type="text" class="form-control" id="dataInicio" name="dataInicioDisplay"
                [(ngModel)]="dataInicioDisplay" required appDateFormat (ngModelChange)="onDataInicioChange($event)"
                placeholder="DD/MM/AAAA" #dataInicio="ngModel" maxlength="10">
              <div *ngIf="dataInicio.invalid && dataInicio.touched" class="text-danger">
                <small *ngIf="dataInicio.errors?.['required']">Data de início é obrigatória</small>
                <small>Formato deve ser DD/MM/AAAA</small>
              </div>
              <div class="form-text">Digite a data no formato DD/MM/AAAA</div>
            </div>

            <div class="col-md-6 mb-3">
              <label class="form-label">Horário de Início</label>
              <div class="form-control-plaintext border rounded p-2 bg-light">
                {{ horarioInicio || 'Selecione um plano' }}
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Data de Término</label>
              <div class="form-control-plaintext border rounded p-2 bg-light">
                {{ dataTermino || 'Selecione um plano' }}
              </div>
            </div>

            <div class="col-md-6 mb-3">
              <label class="form-label">Horário de Término</label>
              <div class="form-control-plaintext border rounded p-2 bg-light">
                {{ horarioFim || 'Selecione um plano' }}
              </div>
            </div>
          </div>

          <!-- Resumo do Aluguel -->
          <div class="alert alert-success" *ngIf="aluguelFormData.totalPriceDeskRentals > 0">
            <div class="d-flex justify-content-between">
              <strong>Total do Aluguel:</strong>
              <strong>R$ {{ aluguelFormData.totalPriceDeskRentals }}</strong>
            </div>
          </div>

        </div>

        <!-- Footer do Modal -->
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="onFechar()">
            Cancelar
          </button>
          <button type="submit" class="btn btn-success" [disabled]="!aluguelForm.form.valid || salvando">
            <span *ngIf="salvando" class="spinner-border spinner-border-sm me-2"></span>
            {{ salvando ? 'Processando...' : 'Confirmar Aluguel' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>