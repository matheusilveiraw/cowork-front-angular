<!-- Notificações -->
<div class="notifications-container">
  <div *ngFor="let notification of notifications" class="notification" [class.success]="notification.type === 'success'"
    [class.error]="notification.type === 'error'" [class.info]="notification.type === 'info'"
    [class.hiding]="!notification.visible">
    <div class="notification-content">
      <div class="notification-message">
        {{ notification.message }}
      </div>
      <button class="notification-close" (click)="removeNotification(notification.id)">
        ×
      </button>
    </div>
  </div>
</div>

<div class="card mb-4">
  <div class="card-header">
    <h4 class="mb-0">Mesas</h4>
    <p class="text-muted mb-0">Gerencie as mesas do seu coworking</p>
  </div>

  <div class="card-body">
    <!-- Botões de Ação -->
    <div class="action-buttons mb-4">
      <button class="btn btn-primary me-2" (click)="abrirModalCadastro()">
        Nova Mesa
      </button>
      <button class="btn btn-info me-2" (click)="abrirModalAluguelGeral()">
        Alugar Mesa
      </button>
    </div>

    <!-- Loading -->
    <div *ngIf="loading" class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Carregando...</span>
      </div>
      <p class="mt-2">Carregando mesas...</p>
    </div>

    <!-- Lista Vazia -->
    <div *ngIf="!loading && mesas.length === 0" class="text-center py-5">
      <i class="fas fa-desktop text-muted" style="font-size: 48px;"></i>
      <h5 class="mt-3">Nenhuma mesa cadastrada</h5>
      <p class="text-muted">Clique em "Nova Mesa" para começar</p>
    </div>

    <!-- Grid de Mesas -->
    <div class="row" *ngIf="!loading && mesas.length > 0">
      <div class="col-lg-3 col-md-4 col-sm-6 mb-4" *ngFor="let mesa of mesas">
        <div class="mesa-card">
          <!-- Header da Mesa -->
          <div class="mesa-header">
            <div class="mesa-numero">
              <span class="numero">{{ mesa.numberDesks }}</span>
            </div>
            <div class="mesa-status" [class]="getStatusClass(mesa)">
              {{ getStatusText(mesa) }}
            </div>
          </div>

          <!-- Corpo da Mesa -->
          <div class="mesa-body">
            <h6 class="mesa-nome">{{ mesa.nameDesks || 'Mesa sem nome' }}</h6>

            <div class="mesa-info">
              <div class="info-item">
                <small>Próxima disponibilidade: {{ getProximaDisponibilidade(mesa) }}</small>
              </div>
            </div>
          </div>

          <!-- Ações da Mesa -->
          <div class="mesa-actions">
            <!-- REMOVIDO: [disabled]="!estaDisponivel(mesa)" - botão sempre habilitado -->
            <button class="btn btn-success btn-sm btn-icon" (click)="abrirModalAluguel(mesa)" title="Alugar mesa">
              Alugar
            </button>

            <button class="btn btn-primary btn-sm btn-icon" (click)="abrirModalEdicao(mesa)" title="Editar mesa">
              Editar
            </button>

            <button class="btn btn-danger btn-sm btn-icon" (click)="confirmarExclusao(mesa)" title="Excluir mesa">
              Excluir
            </button>

            <button class="btn btn-info btn-sm btn-icon" (click)="abrirModalCalendarioMesa(mesa)"
              title="Ver calendário">
              Calendário
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Resumo -->
    <div *ngIf="!loading && mesas.length > 0" class="row mt-4">
      <div class="col-12">
        <div class="stats-summary">
          <div class="stat-item">
            <span class="stat-number">{{ mesas.length }}</span>
            <span class="stat-label">Total de Mesas</span>
          </div>
          <div class="stat-item">
            <span class="stat-number">{{ getMesasDisponiveis() }}</span>
            <span class="stat-label">Disponíveis</span>
          </div>
          <div class="stat-item">
            <span class="stat-number">{{ getMesasOcupadas() }}</span>
            <span class="stat-label">Ocupadas</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Cadastro de Mesa -->
<div class="modal-backdrop fade show" *ngIf="abrirModalCadastroMesa"></div>

<div class="modal fade show d-block" *ngIf="abrirModalCadastroMesa" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <!-- Header do Modal -->
      <div class="modal-header">
        <h5 class="modal-title">
          {{ mesaEditando ? 'Editar Mesa' : 'Nova Mesa' }}
        </h5>
        <button type="button" class="btn-close" (click)="fecharModalCadastro()" aria-label="Close"></button>
      </div>

      <!-- Formulário -->
      <form (ngSubmit)="salvarMesa()" #mesaForm="ngForm">
        <div class="modal-body">

          <!-- Número da Mesa -->
          <div class="mb-3">
            <label for="numeroMesa" class="form-label">Número da Mesa *</label>
            <input type="number" class="form-control" id="numeroMesa" name="numberDesks"
              [(ngModel)]="mesaFormData.numberDesks" required min="1" #numeroInput="ngModel">
            <div *ngIf="numeroInput.invalid && numeroInput.touched" class="text-danger">
              <small *ngIf="numeroInput.errors?.['required']">Número da mesa é obrigatório</small>
              <small *ngIf="numeroInput.errors?.['min']">Número deve ser maior que zero</small>
            </div>
          </div>

          <!-- Nome da Mesa -->
          <div class="mb-3">
            <label for="nomeMesa" class="form-label">Nome da Mesa</label>
            <input type="text" class="form-control" id="nomeMesa" name="nameDesks" [(ngModel)]="mesaFormData.nameDesks"
              placeholder="Ex: Mesa da Janela, Mesa do Fundo..." maxlength="50">
            <div class="form-text">Opcional - ajuda a identificar a mesa</div>
          </div>

        </div>

        <!-- Footer do Modal -->
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="fecharModalCadastro()">
            Cancelar
          </button>
          <button type="submit" class="btn btn-primary" [disabled]="!mesaForm.form.valid || salvando">
            <span *ngIf="salvando" class="spinner-border spinner-border-sm me-2"></span>
            {{ salvando ? 'Salvando...' : (mesaEditando ? 'Atualizar' : 'Cadastrar') }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal de Aluguel de Mesa -->
<div class="modal-backdrop fade show" *ngIf="abrirModalAluguelMesa"></div>

<div class="modal fade show d-block" *ngIf="abrirModalAluguelMesa" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered modal-lg" role="document">
    <div class="modal-content">
      <!-- Header do Modal -->
      <div class="modal-header">
        <h5 class="modal-title">
          {{ mesaSelecionadaAluguel ? 'Alugar Mesa ' + mesaSelecionadaAluguel.numberDesks : 'Alugar Mesa' }}
        </h5>
        <button type="button" class="btn-close" (click)="fecharModalAluguel()" aria-label="Close"></button>
      </div>

      <!-- Formulário de Aluguel -->
      <form (ngSubmit)="salvarAluguel()" #aluguelForm="ngForm">
        <div class="modal-body">

          <!-- Seleção de Mesa (se for aluguel geral) -->
          <div class="mb-3" *ngIf="!mesaSelecionadaAluguel">
            <label for="mesaSelect" class="form-label">Selecionar Mesa *</label>
            <select class="form-select" id="mesaSelect" name="idDesks" [(ngModel)]="aluguelFormData.idDesks" required
              #mesaSelect="ngModel">
              <option value="">Selecione uma mesa</option>
              <!-- REMOVIDO: mesasDisponiveis - agora mostra todas as mesas -->
              <option *ngFor="let mesa of mesas" [value]="mesa.idDesks">
                Mesa {{ mesa.numberDesks }} - {{ mesa.nameDesks || 'Sem nome' }}
              </option>
            </select>
            <div *ngIf="mesaSelect.invalid && mesaSelect.touched" class="text-danger">
              <small>Seleção da mesa é obrigatória</small>
            </div>
          </div>

          <!-- Informações da Mesa Selecionada (QUANDO CLICAR EM ALUGAR) -->
          <div class="mb-3" *ngIf="mesaSelecionadaAluguel">
            <label class="form-label">Mesa Selecionada</label>
            <div class="alert alert-info">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <strong>Mesa {{ mesaSelecionadaAluguel.numberDesks }}</strong> -
                  {{ mesaSelecionadaAluguel.nameDesks || 'Sem nome' }}
                </div>
                <button type="button" class="btn btn-outline-secondary btn-sm" (click)="abrirModalAluguelGeral()"
                  title="Alterar mesa">
                  Alterar Mesa
                </button>
              </div>
            </div>
          </div>

          <!-- Seleção de Cliente -->
          <div class="mb-3">
            <label for="clienteSelect" class="form-label">Cliente *</label>
            <select class="form-select" id="clienteSelect" name="idCustomers" [(ngModel)]="aluguelFormData.idCustomers"
              required #clienteSelect="ngModel">
              <option value="">Selecione um cliente</option>
              <option *ngFor="let cliente of clientes" [value]="cliente.idCustomers">
                {{ cliente.nameCustomers }} - {{ cliente.emailCustomers }}
              </option>
            </select>
            <div *ngIf="clienteSelect.invalid && clienteSelect.touched" class="text-danger">
              <small>Seleção do cliente é obrigatória</small>
            </div>
            <div class="form-text">
              <a href="javascript:void(0)" (click)="abrirModalCliente()" class="text-primary">
                + Cadastrar novo cliente
              </a>
            </div>
          </div>

          <!-- Seleção de Plano -->
          <div class="mb-3">
            <label for="planoSelect" class="form-label">Plano de Aluguel *</label>
            <select class="form-select" id="planoSelect" name="idRentalPlans"
              [(ngModel)]="aluguelFormData.idRentalPlans" required (change)="onPlanoChange()" #planoSelect="ngModel">
              <option value="">Selecione um plano</option>
              <option *ngFor="let plano of planosAluguel" [value]="plano.idRentalPlans">
                {{ plano.planNameRentalPlans }} - R$ {{ plano.priceRentalPlans }}
              </option>
            </select>
            <div *ngIf="planoSelect.invalid && planoSelect.touched" class="text-danger">
              <small>Seleção do plano é obrigatória</small>
            </div>
          </div>

          <!-- Período do Aluguel -->
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="dataInicio" class="form-label">Data de Início *</label>
              <input type="text" class="form-control" id="dataInicio" name="dataInicioDisplay"
                [(ngModel)]="dataInicioDisplay" required (ngModelChange)="onDataInicioChange($event)"
                placeholder="DD/MM/AAAA" #dataInicio="ngModel" maxlength="10">
              <div *ngIf="dataInicio.invalid && dataInicio.touched" class="text-danger">
                <small *ngIf="dataInicio.errors?.['required']">Data de início é obrigatória</small>
                <small>Formato deve ser DD/MM/AAAA</small>
              </div>
              <div class="form-text">Digite a data no formato DD/MM/AAAA</div>
            </div>

            <div class="col-md-6 mb-3">
              <label class="form-label">Horário de Início</label>
              <div class="form-control-plaintext border rounded p-2 bg-light">
                {{ horarioInicio || 'Selecione um plano' }}
              </div>
            </div>
          </div>

          <!-- Resumo do Aluguel -->
          <div class="alert alert-success" *ngIf="aluguelFormData.totalPriceDeskRentals > 0">
            <div class="d-flex justify-content-between">
              <strong>Total do Aluguel:</strong>
              <strong>R$ {{ aluguelFormData.totalPriceDeskRentals }}</strong>
            </div>
          </div>
        </div>

        <!-- Footer do Modal -->
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" (click)="fecharModalAluguel()">
            Cancelar
          </button>
          <button type="submit" class="btn btn-success" [disabled]="!aluguelForm.form.valid || salvandoAluguel">
            <span *ngIf="salvandoAluguel" class="spinner-border spinner-border-sm me-2"></span>
            {{ salvandoAluguel ? 'Processando...' : 'Confirmar Aluguel' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Modal de Calendário -->
<div class="modal-backdrop fade show" *ngIf="abrirModalCalendario"></div>

<div class="modal fade show d-block" *ngIf="abrirModalCalendario" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
    <div class="modal-content">
      <!-- Header do Modal -->
      <div class="modal-header">
        <h5 class="modal-title">
          Calendário da Mesa
        </h5>
        <button type="button" class="btn-close" (click)="fecharModalCalendario()" aria-label="Close"></button>
      </div>

      <div class="modal-body">
        <div class="mb-4">
          <label for="mesaCalendarioSelect" class="form-label">Selecionar Mesa</label>
          <select class="form-select" id="mesaCalendarioSelect" (change)="mudarMesaCalendario($event)"
            [value]="mesaCalendarioAtual?.idDesks">
            <option *ngFor="let mesa of mesas" [value]="mesa.idDesks"
              [selected]="mesa.idDesks === mesaCalendarioAtual?.idDesks">
              Mesa {{ mesa.numberDesks }} - {{ mesa.nameDesks || 'Sem nome' }}
            </option>
          </select>
        </div>

        <div *ngIf="loadingCalendario" class="text-center py-3">
          <div class="spinner-border spinner-border-sm text-primary" role="status">
            <span class="visually-hidden">Carregando...</span>
          </div>
          <small class="text-muted ms-2">Carregando agendamentos...</small>
        </div>

        <!-- Calendário -->
        <div *ngIf="!loadingCalendario" class="calendar-container">
          <!-- Controles do Mês -->
          <div class="calendar-header mb-3">
            <div class="row align-items-center">
              <div class="col">
                <button class="btn btn-outline-primary btn-sm" (click)="mesAnterior()">
                  ‹ Anterior
                </button>
              </div>
              <div class="col text-center">
                <h5 class="mb-0 fw-bold text-primary">{{ getNomeMes() }}</h5>
              </div>
              <div class="col text-end">
                <button class="btn btn-outline-primary btn-sm" (click)="mesProximo()">
                  Próximo ›
                </button>
              </div>
            </div>
          </div>

          <!-- Dias da Semana -->
          <div class="calendar-weekdays row g-0 mb-2">
            <div class="col text-center p-2 fw-bold text-muted" *ngFor="let dia of getDiasDaSemana()">
              {{ dia }}
            </div>
          </div>

          <!-- Dias do Mês -->
          <div class="calendar-days">
            <div class="row g-0">
              <div class="col p-1" *ngFor="let dia of getDiasDoMes(); let i = index">
                <div class="calendar-day-cell h-100" [class]="getDiaClass(dia)" [title]="getTooltipDia(dia)">

                  <div *ngIf="dia; else emptyDay">
                    <!-- Número do Dia -->
                    <div class="day-number" [class.text-white]="ehHoje(dia)">
                      {{ dia.getDate() }}
                    </div>

                    <!-- APENAS TURNOS OCUPADOS (dias disponíveis ficam vazios) -->
                    <div class="day-shifts mt-1" *ngIf="getTurnosDoDia(dia).length > 0">
                      <div *ngFor="let turno of getTurnosDoDia(dia)" class="shift-indicator">
                        <span class="badge {{ getClasseTurno(turno.nome) }} shift-badge"
                          [title]="getTituloTurno(turno.nome)">
                          {{ getAbreviacaoTurno(turno.nome) }}
                        </span>
                      </div>
                    </div>

                    <!-- Indicador visual rápido de status do dia -->
                    <div class="day-status-indicator mt-1">
                      <small *ngIf="estaDiaOcupado(dia)" class="text-danger">
                        <i class="fas fa-times-circle"></i> Ocupado
                      </small>
                      <small *ngIf="!estaDiaOcupado(dia)" class="text-success">
                        <i class="fas fa-check-circle"></i> Disponível
                      </small>
                    </div>
                  </div>

                  <ng-template #emptyDay>
                    <div class="empty-day h-100"></div>
                  </ng-template>

                </div>
              </div>
            </div>
          </div>

          <!-- Legenda Dinâmica dos Turnos -->
          <!-- Legenda Dinâmica dos Turnos -->
          <div class="calendar-legend mt-4 p-3 bg-light rounded">
            <div class="row">
              <div class="col-md-6">
                <small class="fw-bold text-muted">Legenda dos Turnos Ocupados:</small>
                <div class="mt-2">
                  <div *ngFor="let turno of turnos" class="d-inline-block me-3 mb-2">
                    <span class="badge {{ getCorTurno(turno.nameRentalShifts) }} shift-badge me-1"
                      [title]="getDescricaoTurno(turno.nameRentalShifts)">
                      {{ getAbreviacaoTurno(turno.nameRentalShifts) }}
                    </span>
                    <small>= {{ turno.nameRentalShifts }}</small>
                    <br>
                    <small class="text-muted">{{ turno.startTimeRentalShifts }} às {{ turno.endTimeRentalShifts
                      }}</small>
                  </div>

                  <!-- Mensagem quando não há turnos -->
                  <div *ngIf="turnos.length === 0" class="text-muted">
                    <small>Nenhum turno cadastrado</small>
                  </div>
                </div>
              </div>
              <div class="col-md-6">
                <small class="fw-bold text-muted">Status dos Dias:</small>
                <div class="mt-2">
                  <div class="mb-1">
                    <span class="badge bg-success me-2">✓</span>
                    <small>Dia Disponível (sem turnos ocupados)</small>
                  </div>
                  <div class="mb-1">
                    <span class="badge bg-danger me-2">✗</span>
                    <small>Dia Ocupado (com turnos marcados)</small>
                  </div>
                  <div class="mb-1">
                    <span class="badge bg-primary me-2">ℹ</span>
                    <small>Legenda mostra apenas turnos ocupados</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="fecharModalCalendario()">
          Fechar
        </button>
      </div>
    </div>
  </div>
</div>